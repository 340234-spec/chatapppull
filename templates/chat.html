<!DOCTYPE html>
<html>
<head>
  <title>Chat App</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    #modPanel { display: none; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    .message { margin: 5px 0; }
  </style>
</head>
<body>
  <h2>Welcome to Chat</h2>

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="1011927387913-iuaom6p156jlc026ujnfd3ctkeh6o3re.apps.googleusercontent.com"
       data-callback="handleGoogleLogin"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin" data-type="standard"></div>

  <!-- Chat UI -->
  <div id="chatBox"></div>
  <input id="msgInput" placeholder="Type a message..." />
  <button onclick="sendMessage()">Send</button>

  <!-- Mod Dashboard -->
  <div id="modPanel">
    <h3>Mod Dashboard</h3>
    <input id="banInput" placeholder="Ban email..." />
    <button onclick="banUser()">Ban</button>
    <div id="history"></div>
  </div>

  <script>
    const socket = io();
    let currentUser = null;
    let isMod = false;

    // Restore login from localStorage
    const savedUser = JSON.parse(localStorage.getItem("user"));
    if (savedUser) {
      currentUser = savedUser.name || savedUser.email;
      isMod = savedUser.email === "340234@apps.wilsonareasd.org";
      if (isMod) document.getElementById("modPanel").style.display = "block";
      socket.emit("join", { username: currentUser, email: savedUser.email });
    }

    function handleGoogleLogin(response) {
      const decoded = jwt_decode(response.credential);
      const email = decoded.email;
      const name = decoded.name;

      localStorage.setItem("user", JSON.stringify(decoded));
      currentUser = name || email;
      isMod = email === "340234@apps.wilsonareasd.org";
      if (isMod) document.getElementById("modPanel").style.display = "block";
      socket.emit("join", { username: currentUser, email });
    }

    function sendMessage() {
      const text = document.getElementById("msgInput").value;
      socket.emit("message", { username: currentUser, text });
    }

    function banUser() {
      const email = document.getElementById("banInput").value;
      socket.emit("ban", { email });
    }

    socket.on("message", msg => {
      const div = document.createElement("div");
      div.className = "message";
      div.textContent = msg;
      document.getElementById("chatBox").appendChild(div);
    });

    socket.on("history", history => {
      document.getElementById("history").innerHTML = "<h4>Message History</h4>";
      history.forEach(msg => {
        const div = document.createElement("div");
        div.textContent = msg;
        document.getElementById("history").appendChild(div);
      });
    });

    function jwt_decode(token) {
      const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
      const json = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join(''));
      return JSON.parse(json);
    }
  </script>
</body>
</html>
